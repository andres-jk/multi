{% extends 'base.html' %}

{% block title %}Recibos de Obra{% endblock %}

{% block nav %}
{% if solo_recibos %}
<a href="{% url 'recibos:lista_recibos' %}">Recibos de Obra</a>
<a href="{% url 'usuarios:logout' %}">Cerrar Sesión</a>
{% else %}
<a href="/panel/admin/productos/">Administrar Productos</a>
<a href="/panel/admin/clientes/">Clientes</a>
<a href="/panel/">Pedidos</a>
<a href="/">Inicio</a>
{% endif %}
{% endblock %}

{% block content %}
<div class="card">
    <h1 class="highlight">Recibos de Obra</h1>
    
    {% if not solo_recibos %}
    <div class="search-container">
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
            <form method="get" action="{% url 'recibos:lista_recibos' %}" class="search-form" style="flex: 1;">
                <input type="text" name="search" placeholder="Buscar por pedido, cliente o producto..." value="{{ request.GET.search }}">
                <button type="submit" class="btn">Buscar</button>
            </form>
            <a href="{% url 'recibos:diagnostico_devoluciones' %}" class="btn btn-info" style="background: #17a2b8; white-space: nowrap;">
                🔍 Diagnóstico de Devoluciones
            </a>
        </div>
    </div>
    {% endif %}
    
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Producto(s)</th>
                    <th>Cantidad</th>
                    <th>Estado</th>
                    <th>Fecha Entrega</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for recibo in recibos %}
                <tr>
                    <td>{{ recibo.id }}</td>
                    <td>{{ recibo.cliente.usuario.get_full_name }}</td>
                    <td>
                        {% if recibo.detalles.exists %}
                            <span class="badge consolidado">Múltiple</span>
                            <ul class="productos-list">
                                {% for detalle in recibo.detalles.all %}
                                <li>{{ detalle.producto.nombre }} ({{ detalle.cantidad_solicitada }})</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            {% if recibo.primer_producto %}
                                {{ recibo.primer_producto.nombre }}
                            {% else %}
                                Sin productos
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>{{ recibo.cantidad_solicitada }}</td>
                    <td>{{ recibo.get_estado_display }}</td>                    <td>{{ recibo.fecha_entrega|date:"d/m/Y H:i" }}</td>
                    <td class="actions">
                        <a href="{% url 'recibos:generar_pdf' recibo.id %}" class="btn btn-sm" title="Ver PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        
                        <!-- Botón para administrar productos individuales -->
                        <a href="{% url 'recibos:administrar_productos_individuales' recibo.id %}" class="btn btn-sm btn-info" title="Administrar Estado de Productos">
                            <i class="fas fa-cogs"></i> Productos
                        </a>
                        
                        {% if recibo.estado != 'DEVUELTO' and recibo.cantidad_pendiente > 0 %}
                            {% if recibo.detalles.exists %}
                                <a href="{% url 'recibos:registrar_devolucion_consolidado' recibo.id %}" class="btn btn-sm btn-primary" title="Registrar Devolución">
                                    <i class="fas fa-undo"></i> Devolución
                                </a>
                            {% else %}
                                <a href="{% url 'recibos:registrar_devolucion' recibo.id %}" class="btn btn-sm btn-primary" title="Registrar Devolución">
                                    <i class="fas fa-undo"></i> Devolución
                                </a>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7">No hay recibos registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.search-container {
    margin-bottom: 20px;
}

.search-form {
    display: flex;
    gap: 10px;
}

.search-form input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.actions {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.85rem;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.consolidado {
    background-color: #e3f2fd;
    color: #1565c0;
    border: 1px solid #bbdefb;
}

.productos-list {
    margin: 0;
    padding-left: 15px;
    font-size: 0.9em;
}
</style>
{% endblock %}
