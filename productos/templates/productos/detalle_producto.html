{% extends 'base.html' %}

{% block title %}{{ producto.nombre }} - MultiAndamios{% endblock %}

{% block content %}
<div class="container product-detail">
    <div class="card">
        <div class="product-header">
            <h1 class="highlight">{{ producto.nombre }}</h1>
            <a href="{% url 'productos:catalogo_productos' %}" class="btn btn-secondary">Volver al Catálogo</a>
        </div>
        
        <div class="product-content">
            <div class="product-image">
                {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}">
                {% else %}
                <div class="no-image">No hay imagen disponible</div>
                {% endif %}
            </div>
            
            <div class="product-info">
                <div class="price-section">
                    <h2 class="price-mensual">${{ producto.precio }}</h2>
                    <span class="rent-type">por mes</span>
                    {% if producto.precio_semanal %}
                    <h3 class="price-semanal">${{ producto.precio_semanal }}</h3>
                    <span class="rent-type">por semana</span>
                    {% endif %}
                </div>
                
                <div class="availability">
                    <span class="{% if producto.cantidad_disponible > 0 %}in-stock{% else %}out-stock{% endif %}">
                        {% if producto.cantidad_disponible > 0 %}
                            Disponible ({{ producto.cantidad_disponible }} unidades)
                        {% else %}
                            No disponible
                        {% endif %}
                    </span>
                </div>
                
                <div class="description">
                    <h3>Descripción</h3>
                    <p>{{ producto.descripcion }}</p>
                </div>
                
                <div class="specs">
                    <h3>Detalles</h3>
                    <ul>
                        <li><strong>Tipo de Renta:</strong> {{ producto.tipo_renta }}</li>
                        <li><strong>Referencia:</strong> #{{ producto.id_producto }}</li>
                    </ul>
                </div>
                
                {% if producto.cantidad_disponible > 0 %}
                <div class="add-to-cart">
                    <form method="post" action="{% url 'usuarios:agregar_al_carrito' producto.id_producto %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="cantidad">Cantidad:</label>
                            <input type="number" name="cantidad" id="cantidad" min="1" max="{{ producto.cantidad_disponible }}" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="tipo_renta">Tipo de renta:</label>
                            <select name="tipo_renta" id="tipo_renta" required>
                                <option value="mensual">Mensual</option>
                                <option value="semanal">Semanal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="periodo_renta">Período de renta:</label>
                            <input type="number" name="periodo_renta" id="periodo_renta" min="1" max="12" value="1" required>
                            <small>Ingrese el número de meses o semanas según el tipo de renta seleccionado</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Añadir al Carrito</button>
                    </form>
                </div>
                {% else %}
                <div class="not-available">
                    <p>Este producto no está disponible actualmente.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.price-section {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 20px;
}

.price-mensual, .price-semanal {
    margin: 0;
    color: #007bff;
}

.price-semanal {
    font-size: 1.2em;
    color: #28a745;
}

.rent-type {
    font-size: 0.9em;
    color: #6c757d;
    margin-bottom: 10px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.form-group small {
    display: block;
    color: #6c757d;
    font-size: 0.8em;
    margin-top: 5px;
}

#precio-preview {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    border-left: 4px solid #007bff;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoRentaSelect = document.getElementById('tipo_renta');
    const periodoInput = document.getElementById('periodo_renta');
    const cantidadInput = document.getElementById('cantidad');
    
    // Precios del producto
    const precioMensual = {{ producto.precio }};
    const precioSemanal = {% if producto.precio_semanal %}{{ producto.precio_semanal }}{% else %}{{ producto.precio|floatformat:2 }} / 4{% endif %};
    
    function actualizarPrecioPreview() {
        const tipoRenta = tipoRentaSelect.value;
        const periodo = parseInt(periodoInput.value) || 1;
        const cantidad = parseInt(cantidadInput.value) || 1;
        
        let precioUnitario = tipoRenta === 'semanal' ? precioSemanal : precioMensual;
        let total = precioUnitario * periodo * cantidad;
        let unidadTiempo = tipoRenta === 'semanal' ? 'semana' : 'mes';
        let unidadTiempoPlural = tipoRenta === 'semanal' ? 'semanas' : 'meses';
        
        let preview = document.getElementById('precio-preview');
        if (!preview) {
            preview = document.createElement('div');
            preview.id = 'precio-preview';
            periodoInput.parentNode.appendChild(preview);
        }
        
        preview.innerHTML = `
            <strong>Precio estimado:</strong><br>
            $${precioUnitario.toFixed(2)} por ${unidadTiempo} × ${periodo} ${periodo > 1 ? unidadTiempoPlural : unidadTiempo} × ${cantidad} unidad${cantidad > 1 ? 'es' : ''} = 
            <span style="color: #007bff; font-weight: bold;">$${total.toFixed(2)}</span>
        `;
    }
    
    function actualizarEtiquetaPeriodo() {
        const tipoRenta = tipoRentaSelect.value;
        const label = document.querySelector('label[for="periodo_renta"]');
        const small = document.querySelector('label[for="periodo_renta"]').nextElementSibling.nextElementSibling;
        
        if (tipoRenta === 'semanal') {
            label.textContent = 'Período de renta (semanas):';
            small.textContent = 'Ingrese el número de semanas';
        } else {
            label.textContent = 'Período de renta (meses):';
            small.textContent = 'Ingrese el número de meses';
        }
    }
    
    // Event listeners
    tipoRentaSelect.addEventListener('change', function() {
        actualizarEtiquetaPeriodo();
        actualizarPrecioPreview();
    });
    
    periodoInput.addEventListener('input', actualizarPrecioPreview);
    cantidadInput.addEventListener('input', actualizarPrecioPreview);
    
    // Inicializar
    actualizarEtiquetaPeriodo();
    actualizarPrecioPreview();
});
</script>
{% endblock %}
