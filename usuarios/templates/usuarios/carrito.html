{% extends 'base.html' %}
{% block title %}Carrito{% endblock %}

{% block nav %}
<a href="{% url 'usuarios:inicio_cliente' %}">Inicio</a>
<a href="{% url 'productos:catalogo_productos' %}">Productos</a>
{% endblock %}

{% block content %}
<div class="card card-carrito">
    <h1 class="highlight">Carrito de Alquiler</h1>
      {% if items_carrito %}
    <div class="documentos-botones" style="margin-bottom: 20px;">
        <a href="{% url 'usuarios:generar_cotizacion_pdf' %}" class="btn btn-info" target="_blank">
            <i class="fas fa-file-pdf"></i> Generar Cotización PDF
        </a>
        {% if user.is_staff or user.rol == 'admin' or user.rol == 'empleado' %}
        <a href="{% url 'usuarios:generar_remision_pdf' %}" class="btn btn-info" target="_blank">
            <i class="fas fa-file-export"></i> Generar Remisión PDF
        </a>
        {% endif %}
    </div>

    <form method="post" action="{% url 'usuarios:actualizar_carrito' %}">
        {% csrf_token %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Peso (kg)</th>
                        <th>Tipo de Renta</th>
                        <th>Período</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items_carrito %}
                    <tr>
                        <td>{{ item.producto.nombre }}</td>
                        <td id="precio_{{ item.id }}">
                            ${{ item.precio_unitario|floatformat:2 }}
                            <small class="text-muted d-block">
                                {% if item.tipo_renta == 'semanal' %}por semana{% else %}por mes{% endif %}
                            </small>
                        </td>
                        <td>
                            <input type="number" 
                                   name="cantidad_{{ item.id }}" 
                                   value="{{ item.cantidad }}" 
                                   min="1" 
                                   max="{{ item.producto.cantidad_disponible }}"
                                   class="form-control cantidad-input"
                                   style="width: 70px;">
                        </td>
                        <td>{{ item.producto.peso|floatformat:2 }}</td>
                        <td>
                            <select name="tipo_renta_{{ item.id }}" 
                                    class="form-control tipo-renta-select" 
                                    data-item-id="{{ item.id }}"
                                    style="width: 120px;">
                                <option value="mensual" {% if item.tipo_renta == 'mensual' %}selected{% endif %}>
                                    Mensual
                                </option>
                                <option value="semanal" {% if item.tipo_renta == 'semanal' %}selected{% endif %}>
                                    Semanal
                                </option>
                            </select>
                        </td>
                        <td>
                            <input type="number"
                                   name="periodo_{{ item.id }}"
                                   value="{{ item.periodo_renta|default:item.meses_renta }}"
                                   min="1"
                                   max="12"
                                   class="form-control periodo-input"
                                   style="width: 70px;">
                            <small class="text-muted d-block">
                                {{ item.get_descripcion_periodo }}
                            </small>
                        </td>
                        <td>${{ item.subtotal|floatformat:2 }}</td>
                        <td>
                            <a href="{% url 'usuarios:eliminar_del_carrito' item.id %}" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Eliminar
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="text-right"><strong>Total:</strong></td>
                        <td colspan="2"><strong>${{ total|floatformat:2 }}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="cart-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-sync"></i> Actualizar carrito
            </button>
            <a href="{% url 'usuarios:checkout' %}" class="btn btn-success">
                <i class="fas fa-shopping-cart"></i> Proceder al pago
            </a>
        </div>
    </form>
    <div class="d-flex justify-content-end mt-3">
        <strong>Peso total: {{ peso_total|floatformat:2 }} kg</strong>
    </div>
    {% else %}
    <div class="empty-cart">
        <p>No hay productos en el carrito.</p>
        <a href="{% url 'productos:catalogo_productos' %}" class="btn btn-primary">
            <i class="fas fa-shopping-cart"></i> Ir al catálogo
        </a>
    </div>
    {% endif %}
</div>

<style>
.documentos-botones {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding: 10px;
}

.documentos-botones .btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 15px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.documentos-botones .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.documentos-botones .btn i {
    font-size: 1.1em;
}

.cart-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding: 20px;
}

.empty-cart {
    text-align: center;
    padding: 40px 20px;
}

.empty-cart p {
    font-size: 1.2em;
    color: #666;
    margin-bottom: 20px;
}

.table-responsive {
    margin-bottom: 20px;
}

.table th, .table td {
    vertical-align: middle;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cantidadInputs = document.querySelectorAll('.cantidad-input, .periodo-input');
    const tipoRentaSelects = document.querySelectorAll('.tipo-renta-select');
    
    cantidadInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value < 1) {
                this.value = 1;
                showNotification('La cantidad debe ser mayor a 0', 'error');
            }
            
            // Obtener el item ID del nombre del input
            const itemId = this.name.split('_')[1];
            updateSubtotal(itemId);
        });
    });
    
    // Agregar event listeners para inputs de período
    const periodoInputs = document.querySelectorAll('.periodo-input');
    periodoInputs.forEach(input => {
        input.addEventListener('change', function() {
            const itemId = this.name.split('_')[1];
            updateSubtotal(itemId);
            
            // Actualizar descripción del período
            const tipoRentaSelect = document.querySelector(`select[name="tipo_renta_${itemId}"]`);
            if (tipoRentaSelect) {
                updateDescripcionPeriodo(itemId, tipoRentaSelect.value);
            }
        });
    });
    
    // Manejar cambios en el tipo de renta
    tipoRentaSelects.forEach(select => {
        select.addEventListener('change', function() {
            const itemId = this.dataset.itemId;
            const tipoRenta = this.value;
            
            // Actualizar precio unitario vía AJAX
            updatePrecioUnitario(itemId, tipoRenta);
            
            // Actualizar descripción del período
            updateDescripcionPeriodo(itemId, tipoRenta);
        });
    });
    
    function updatePrecioUnitario(itemId, tipoRenta) {
        fetch(`/carrito/precio/${itemId}/?tipo_renta=${tipoRenta}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const precioElement = document.getElementById('precio_' + itemId);
                    const smallElement = precioElement.querySelector('small');
                    
                    // Actualizar precio
                    const precioText = precioElement.firstChild;
                    if (precioText && precioText.nodeType === Node.TEXT_NODE) {
                        precioText.textContent = `$${data.precio_unitario.toFixed(2)}`;
                    }
                    
                    // Actualizar etiqueta
                    if (smallElement) {
                        smallElement.textContent = tipoRenta === 'semanal' ? 'por semana' : 'por mes';
                    }
                    
                    // Recalcular subtotal
                    updateSubtotal(itemId);
                } else {
                    console.error('Error al obtener precio:', data.error);
                }
            })
            .catch(error => {
                console.error('Error en la petición:', error);
            });
    }
    
    function updateSubtotal(itemId) {
        const precioElement = document.getElementById('precio_' + itemId);
        const cantidadInput = document.querySelector(`input[name="cantidad_${itemId}"]`);
        const periodoInput = document.querySelector(`input[name="periodo_${itemId}"]`);
        const subtotalElement = document.getElementById('subtotal_' + itemId);
        
        if (precioElement && cantidadInput && periodoInput && subtotalElement) {
            const precioText = precioElement.firstChild.textContent.replace('$', '');
            const precio = parseFloat(precioText);
            const cantidad = parseInt(cantidadInput.value) || 1;
            const periodo = parseInt(periodoInput.value) || 1;
            
            const subtotal = precio * cantidad * periodo;
            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
        }
    }
    
    function updateDescripcionPeriodo(itemId, tipoRenta) {
        const periodoInput = document.querySelector(`input[name="periodo_${itemId}"]`);
        const currentValue = periodoInput.value;
        const descripcion = periodoInput.parentElement.querySelector('small');
        
        if (descripcion) {
            const periodo = parseInt(currentValue);
            if (tipoRenta === 'semanal') {
                descripcion.textContent = `${periodo} semana${periodo > 1 ? 's' : ''}`;
            } else {
                descripcion.textContent = `${periodo} mes${periodo > 1 ? 'es' : ''}`;
            }
        }
    }
});

function showNotification(message, type) {
    // Función para mostrar notificaciones (si existe)
    console.log(`${type}: ${message}`);
}

// Enviar el formulario automáticamente solo al cambiar el tipo de renta, NO el período
window.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.tipo-renta-select').forEach(function(element) {
        element.addEventListener('change', function() {
            let form = element.closest('form');
            if (form) {
                form.submit();
            }
        });
    });
});
</script>
{% endblock %}